# 执行环境及作用域

## 执行环境
Node的全局执行环境是`global`，浏览器的全局执行环境是`window`。执行环境定义了变量和函数有权访问的其他数据，每个执行环境都有一个与之关联的变量对象，环境中定义的所有变量和函数都保存在这个对象中。
- 全局执行环境
- 局部执行环境（函数）：当执行流进入一个函数时，函数的环境会被推入一个环境栈中，而在函数执行之后，栈将其环境弹出，把控制权交给之前的执行环境。

## 作用域

### 作用域链
当代码在一个环境中执行时，会创建变量对象的一个作用域链。作用域链可以保证对执行环境有权访问的所有变量和函数的有序访问。作用域链前端是当前执行的代码所在环境的变量对象。作用域链包含的对象：arguments -> 包含环境 -> 下一个包含环境 -> 全局执行环境（作用域链最后一个对象），内部环境可以通过作用域链访问到外部环境，反之则不能。查询标识符时一级一级往上查询，若没有查到，则undefined。

## 延长作用域链
有些语句可以在作用域链的前端临时增加一个变量对象，该变量对象会在代码执行后被移除。

- try-catch 语句的catch块：会创建一个新的变量对象，其中包含的是被抛出的错误对象的声明
- with(对象)语句：将指定的对象添加到作用域链前端

```javascript

with (expression) statement;
// 使用with关键字的目的是为了简化多次编写访问同一对象的工作，比如下面的例子：

var qs = location.search.substring(1);
var hostName = location.hostname;
var url = location.href;
// 这几行代码都是访问location对象中的属性，如果使用with关键字的话，可以简化代码如下：

with (location){
    var qs = search.substring(1);
    var hostName = hostname;
    var url = href;
}
```

## 块级作用域
JavaScript没有块级作用域
```javascript
function a() {
	var b = 10;
}
a();
console.log(b); // b is not defined
if(true) {
	var a = 10;
}
console.log(a); // 10 存在变量提升

for(var i = 0;i < 10; i++)
{

}
console.log(i); // 10

```
`使用var声明的变量会自动被添加到最接近的环境中`，函数内部，最接近的环境就是函数的局部环境，with语句中，最接近的环境这是函数环境（包含with语句的）。`初始变量没有用var声明，该变量会被自动添加到全局环境中`

## 垃圾收集
JavaScript具有自动垃圾回收机制，找出那些不再继续使用的变量，然后释放其占有的内存。

### 局部变量声明周期
局部变量只在函数执行过程中存在，在这个过程重病，会为局部变量在栈（或堆）内存上分配相应的空间，以便存储它们的值，然后在函数中使用这些变量，直至函数执行结束。这些变量就可以被释放了。

### 垃圾收集方式

#### 标记清除
JavaScript最常用的垃圾收集方式。当变量进入环境，就将这个变量标记为“进入环境”，当变量离开环境，则标记为“离开环境”。可以通过翻转某个特殊的`位`来记录一个变量何时进入环境，或者使用`“进入环境”变量列表`和`”离开环境”变量列表`

### 引用计数
这类方式不太常见，跟踪记录每个值被引用的次数，可能会造成循环引用。
